<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø§Ù„Ùƒ â€” Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#071025;--accent:#4fd1c5;--accent2:#5a67d8}
    *{box-sizing:border-box}
    body{margin:0;font-family:"Cairo",sans-serif;background:linear-gradient(180deg,var(--bg),#02102a);color:#e7f0fb;min-height:100vh}
    .wrap{max-width:1200px;margin:28px auto;padding:18px}
    header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);margin-top:16px}
    .grid{display:grid;grid-template-columns:360px 1fr;gap:18px}
    input,select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:right;font-size:14px;color:#b8c6db}
    th{color:#e7f0fb;font-weight:600}
    .btn{background:linear-gradient(90deg,var(--accent),var(--accent2));border:none;color:#022036;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700}
    .btn:disabled{opacity:0.5;cursor:not-allowed}
    .small{font-size:13px;color:#9fb7cc}
    .loading{text-align:center;padding:20px;color:#9fb7cc}
    .delete-btn{background:#ff6b6b;color:white;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:12px}
    .delete-btn:hover{background:#ff5252}
    @media(max-width:980px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø§Ù„Ùƒ</h1>
        <div class="small" id="ownerInfo">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø©...</div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn" id="logout">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
      </div>
    </header>

    <div id="lockedCard" class="card">
      <div style="display:flex;gap:8px;align-items:center">
        <input id="adminPassInput" type="password" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø§Ù„Ùƒ (Ù…Ø­Ù„ÙŠÙ‹Ø§)" style="flex:1" />
        <button class="btn" id="adminUnlockBtn">ÙØªØ­ Ø§Ù„Ù„ÙˆØ­Ø©</button>
      </div>
      <div class="small" style="margin-top:8px">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©: <code>9999</code></div>
    </div>

    <div id="mainContent" style="display:none">
      <div class="card" style="background:linear-gradient(90deg, rgba(79,209,197,0.05), rgba(90,103,216,0.05));border-color:rgba(79,209,197,0.2)">
        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px">
          <div>
            <div style="font-size:12px;color:#9fb7cc;margin-bottom:4px">Ø­Ø§Ù„Ø© Firebase</div>
            <div id="firebaseStatus" style="font-weight:700">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...</div>
          </div>
          <div style="display:flex;gap:8px">
            <button class="btn" id="syncFromRealtime">ØªØ­Ø¯ÙŠØ« Ù…Ù† Realtime DB</button>
            <button class="btn" id="syncFromFirestore">ØªØ­Ø¯ÙŠØ« Ù…Ù† Firestore</button>
          </div>
        </div>
      </div>

      <div class="grid">
        <div>
          <div class="card">
            <h3>Ù…Ø±Ø´Ø­Ø§Øª</h3>
            <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
              <select id="filterType">
                <option value="all">Ø§Ù„ÙƒÙ„</option>
                <option value="invoice">ÙÙˆØ§ØªÙŠØ±</option>
                <option value="salary">Ù…Ø¹Ø§Ø´Ø§Øª</option>
              </select>
              <select id="filterMandoub">
                <option value="all">ÙƒÙ„ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†</option>
              </select>
              <input id="filterMonth" type="month" />
              <button class="btn" id="apply">ØªØ·Ø¨ÙŠÙ‚</button>
            </div>
            <div style="margin-top:14px">
              <div style="display:flex;gap:10px;flex-wrap:wrap">
                <div class="card" style="padding:10px;flex:1;min-width:120px">
                  <div class="small">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ</div>
                  <div id="sumMonth" style="font-weight:800;font-size:18px;color:#4fd1c5;margin-top:4px">0 Ø±.Ù‚</div>
                </div>
                <div class="card" style="padding:10px;flex:1;min-width:120px">
                  <div class="small">Ø§Ù„ÙÙˆØ§ØªÙŠØ±</div>
                  <div id="sumInv" style="font-weight:800;font-size:18px;color:#5a67d8;margin-top:4px">0 Ø±.Ù‚</div>
                </div>
                <div class="card" style="padding:10px;flex:1;min-width:120px">
                  <div class="small">Ø§Ù„Ù…Ø¹Ø§Ø´Ø§Øª</div>
                  <div id="sumSal" style="font-weight:800;font-size:18px;color:#e7f0fb;margin-top:4px">0 Ø±.Ù‚</div>
                </div>
              </div>
            </div>
            <div style="margin-top:12px;display:flex;gap:8px">
              <button class="btn" id="exportCsv">ØªØµØ¯ÙŠØ± CSV</button>
              <button class="btn" id="refresh" style="background:transparent;color:#9fb7cc;border:1px solid rgba(255,255,255,0.03)">ØªØ­Ø¯ÙŠØ«</button>
            </div>
          </div>
        </div>

        <div>
          <div class="card">
            <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (<span id="recordCount">0</span> Ø³Ø¬Ù„) - Ù…ØµØ¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: <span id="dataSource">-</span></h3>
            <div style="max-height:460px;overflow:auto" id="tableContainer">
              <table>
                <thead>
                  <tr>
                    <th>Ø§Ù„Ù†ÙˆØ¹</th>
                    <th>Ø§Ù„ÙØ¦Ø©/Ø§Ù„Ø§Ø³Ù…</th>
                    <th>Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</th>
                    <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    <th>Ù…Ù„Ø§Ø­Ø¸Ø©</th>
                    <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
                  </tr>
                </thead>
                <tbody id="tableBody">
                  <tr><td colspan="7" class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-analytics-compat.js"></script>

<script>
  // ========== Session & Auth ==========
  const SESSION_KEY = 'app_session_v1';
  function getSession(){ 
    try{ 
      return JSON.parse(localStorage.getItem(SESSION_KEY)||'null'); 
    } catch(e){ 
      return null; 
    } 
  }

  const sess = getSession();
  if(sess && sess.role === 'admin') {
    document.getElementById('ownerInfo').textContent = `Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${sess.username} â€” Ø¯ÙˆØ±: ${sess.role}`;
    document.getElementById('lockedCard').style.display = 'none';
    document.getElementById('mainContent').style.display = 'block';
    initializeFirebase();
  } else {
    document.getElementById('ownerInfo').textContent = 'ØºÙŠØ± Ù…Ø³Ø¬Ù„ ÙƒÙ…Ø§Ù„Ùƒ â€” Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ù‹Ø§';
  }

  document.getElementById('logout').addEventListener('click', ()=> { 
    localStorage.removeItem(SESSION_KEY); 
    window.location.href='login.html'; 
  });

  // ========== Local Password ==========
  const OWNER_PASS = '9999';
  document.getElementById('adminUnlockBtn').addEventListener('click', ()=>{
    const v = document.getElementById('adminPassInput').value.trim();
    if(v === OWNER_PASS){
      document.getElementById('lockedCard').style.display='none';
      document.getElementById('mainContent').style.display='block';
      initializeFirebase();
    } else {
      alert('ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©');
    }
  });

  // ========== Firebase Configuration ==========
  const firebaseConfig = {
    apiKey: "AIzaSyAZdj86H_cYRTP2xQfF0_YqnCZDPnRnWis",
    authDomain: "mandouby-79556.firebaseapp.com",
    databaseURL: "https://mandouby-79556-default-rtdb.firebaseio.com",
    projectId: "mandouby-79556",
    storageBucket: "mandouby-79556.firebasestorage.app",
    messagingSenderId: "842326054163",
    appId: "1:842326054163:web:32d2611067e45c30ef76e6",
    measurementId: "G-EJ14KM885Y"
  };

  let useFirebase = false;
  let database = null;
  let db = null;
  let analytics = null;
  let allTransactions = [];
  let mandoubsList = new Set();
  let currentDataSource = 'none';

  // ========== Initialize Firebase ==========
  function initializeFirebase() {
    try {
      const app = firebase.initializeApp(firebaseConfig);
      database = firebase.database();
      db = firebase.firestore();
      analytics = firebase.analytics();
      useFirebase = true;
      document.getElementById('firebaseStatus').innerHTML = 'âœ… Ù…ØªØµÙ„ (Realtime DB + Firestore)<br><span style="font-size:11px;color:#9fb7cc">Ø¬Ø§Ù‡Ø² Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>';
      console.log('Firebase initialized successfully');
      // ØªØ­Ù…ÙŠÙ„ Ù…Ù† Realtime Database Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹
      loadFromRealtimeDatabase();
    } catch(e){ 
      console.error('Firebase initialization error:', e);
      document.getElementById('firebaseStatus').innerHTML = 'âŒ ØºÙŠØ± Ù…ØªØµÙ„<br><span style="font-size:11px;color:#ff6b6b">ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>';
      document.getElementById('tableBody').innerHTML = '<tr><td colspan="7" class="loading" style="color:#ff6b6b">Firebase ØºÙŠØ± Ù…ØªØµÙ„</td></tr>';
    }
  }

  // ========== Load from Realtime Database ==========
  async function loadFromRealtimeDatabase(){
    if(!useFirebase || !database){
      document.getElementById('tableBody').innerHTML = '<tr><td colspan="7" class="loading" style="color:#ff6b6b">Realtime Database ØºÙŠØ± Ù…ØªØµÙ„</td></tr>';
      return;
    }

    try {
      document.getElementById('tableBody').innerHTML = '<tr><td colspan="7" class="loading">ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Realtime Database...</td></tr>';
      
      const snapshot = await database.ref('transactions').limitToLast(1000).once('value');
      
      allTransactions = [];
      mandoubsList.clear();

      snapshot.forEach((childSnapshot) => {
        const data = childSnapshot.val();
        allTransactions.push({
          id: childSnapshot.key,
          type: data.type,
          category: data.category || null,
          name: data.name || null,
          amount: Number(data.amount || 0),
          date: data.date ? new Date(data.date) : new Date(),
          note: data.note || '',
          mandoub: data.mandoub || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
          createdAt: data.createdAt ? new Date(data.createdAt) : new Date(),
          source: 'realtime'
        });

        if(data.mandoub) mandoubsList.add(data.mandoub);
      });

      // ØªØ±ØªÙŠØ¨ Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø« Ù„Ù„Ø£Ù‚Ø¯Ù…
      allTransactions.sort((a, b) => b.createdAt - a.createdAt);

      currentDataSource = 'Realtime Database';
      document.getElementById('dataSource').textContent = currentDataSource;
      document.getElementById('dataSource').style.color = '#4fd1c5';

      console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${allTransactions.length} Ø¹Ù…Ù„ÙŠØ© Ù…Ù† Realtime Database`);
      
      updateMandoubFilter();
      renderTable(allTransactions);
      updateTotals(allTransactions);

    } catch(error) {
      console.error('Error loading from Realtime Database:', error);
      document.getElementById('tableBody').innerHTML = '<tr><td colspan="7" class="loading" style="color:#ff6b6b">âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message + '</td></tr>';
    }
  }

  // ========== Load from Firestore ==========
  async function loadFromFirestore(){
    if(!useFirebase || !db){
      document.getElementById('tableBody').innerHTML = '<tr><td colspan="7" class="loading" style="color:#ff6b6b">Firestore ØºÙŠØ± Ù…ØªØµÙ„</td></tr>';
      return;
    }

    try {
      document.getElementById('tableBody').innerHTML = '<tr><td colspan="7" class="loading">ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firestore...</td></tr>';
      
      const snapshot = await db.collection('transactions')
        .orderBy('createdAt', 'desc')
        .limit(1000)
        .get();

      allTransactions = [];
      mandoubsList.clear();

      snapshot.forEach(doc => {
        const data = doc.data();
        allTransactions.push({
          id: doc.id,
          type: data.type,
          category: data.category || null,
          name: data.name || null,
          amount: Number(data.amount || 0),
          date: data.date ? (data.date.toDate ? data.date.toDate() : new Date(data.date)) : new Date(),
          note: data.note || '',
          mandoub: data.mandoub || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
          createdAt: data.createdAt ? (data.createdAt.toDate ? data.createdAt.toDate() : new Date(data.createdAt)) : new Date(),
          source: 'firestore'
        });

        if(data.mandoub) mandoubsList.add(data.mandoub);
      });

      currentDataSource = 'Firestore';
      document.getElementById('dataSource').textContent = currentDataSource;
      document.getElementById('dataSource').style.color = '#5a67d8';

      console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${allTransactions.length} Ø¹Ù…Ù„ÙŠØ© Ù…Ù† Firestore`);
      
      updateMandoubFilter();
      renderTable(allTransactions);
      updateTotals(allTransactions);

    } catch(error) {
      console.error('Error loading from Firestore:', error);
      document.getElementById('tableBody').innerHTML = '<tr><td colspan="7" class="loading" style="color:#ff6b6b">âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message + '</td></tr>';
    }
  }

  // ========== Update Mandoub Filter ==========
  function updateMandoubFilter() {
    const select = document.getElementById('filterMandoub');
    select.innerHTML = '<option value="all">ÙƒÙ„ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†</option>';
    
    Array.from(mandoubsList).sort().forEach(mandoub => {
      const option = document.createElement('option');
      option.value = mandoub;
      option.textContent = mandoub;
      select.appendChild(option);
    });
  }

  // ========== Render Table ==========
  function renderTable(data){
    const tbody = document.getElementById('tableBody'); 
    tbody.innerHTML = '';
    
    if(!data || !data.length){
      tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#9fb7cc;padding:30px">ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶</td></tr>';
      document.getElementById('recordCount').textContent = '0';
      return;
    }

    document.getElementById('recordCount').textContent = data.length;

    data.forEach(op=>{
      const tr = document.createElement('tr');
      const label = op.type === 'invoice' ? 'ÙØ§ØªÙˆØ±Ø©' : 'Ù…Ø¹Ø§Ø´';
      const cat = op.category || op.name || '-';
      const mand = op.mandoub || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
      const amt = op.amount.toFixed(2);
      const dt = op.date.toLocaleDateString('ar-QA', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      });
      const typeColor = op.type === 'invoice' ? '#5a67d8' : '#4fd1c5';
      const sourceIcon = op.source === 'realtime' ? 'ğŸ”¥' : 'â˜ï¸';
      
      tr.innerHTML = `
        <td><span style="color:${typeColor};font-weight:600">${label}</span> ${sourceIcon}</td>
        <td>${cat}</td>
        <td style="color:#9fb7cc">${mand}</td>
        <td style="font-weight:800;color:#e7f0fb">${amt} Ø±.Ù‚</td>
        <td style="color:#9fb7cc;font-size:13px">${dt}</td>
        <td style="color:#9fb7cc;font-size:12px">${op.note || '-'}</td>
        <td><button class="delete-btn" data-id="${op.id}" data-source="${op.source}">Ø­Ø°Ù</button></td>
      `;
      
      tbody.appendChild(tr);

      tr.querySelector('.delete-btn').addEventListener('click', () => deleteTransaction(op.id, op.source));
    });
  }

  // ========== Delete Transaction ==========
  async function deleteTransaction(docId, source) {
    if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ\n\nâš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡!')) {
      return;
    }

    try {
      if(source === 'realtime') {
        await database.ref('transactions/' + docId).remove();
        console.log('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù…Ù† Realtime Database:', docId);
      } else if(source === 'firestore') {
        await db.collection('transactions').doc(docId).delete();
        console.log('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù…Ù† Firestore:', docId);
      }
      
      if(analytics) {
        analytics.logEvent('delete_transaction', { doc_id: docId, source: source });
      }

      alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­');
      
      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      if(source === 'realtime') {
        await loadFromRealtimeDatabase();
      } else {
        await loadFromFirestore();
      }
      
    } catch(error) {
      console.error('Error deleting transaction:', error);
      alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù:\n' + error.message);
    }
  }

  // ========== Update Totals ==========
  function updateTotals(data) {
    let totalAmount = 0;
    let invoicesAmount = 0;
    let salariesAmount = 0;

    data.forEach(op => {
      const amount = op.amount;
      totalAmount += amount;
      
      if(op.type === 'invoice') {
        invoicesAmount += amount;
      } else if(op.type === 'salary') {
        salariesAmount += amount;
      }
    });

    document.getElementById('sumMonth').textContent = totalAmount.toFixed(2) + ' Ø±.Ù‚';
    document.getElementById('sumInv').textContent = invoicesAmount.toFixed(2) + ' Ø±.Ù‚';
    document.getElementById('sumSal').textContent = salariesAmount.toFixed(2) + ' Ø±.Ù‚';
  }

  // ========== Apply Filters ==========
  document.getElementById('apply').addEventListener('click', () => {
    const typeFilter = document.getElementById('filterType').value;
    const mandoubFilter = document.getElementById('filterMandoub').value;
    const monthFilter = document.getElementById('filterMonth').value;

    let filtered = allTransactions.slice();

    if(typeFilter !== 'all') {
      filtered = filtered.filter(op => op.type === typeFilter);
    }

    if(mandoubFilter !== 'all') {
      filtered = filtered.filter(op => op.mandoub === mandoubFilter);
    }

    if(monthFilter) {
      const [year, month] = monthFilter.split('-');
      filtered = filtered.filter(op => {
        const opDate = new Date(op.date);
        return opDate.getFullYear() === Number(year) && (opDate.getMonth() + 1) === Number(month);
      });
    }

    renderTable(filtered);
    updateTotals(filtered);
  });

  // ========== Button Events ==========
  document.getElementById('syncFromRealtime').addEventListener('click', async () => {
    const btn = document.getElementById('syncFromRealtime');
    const originalText = btn.textContent;
    btn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
    btn.disabled = true;
    await loadFromRealtimeDatabase();
    alert('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Realtime Database');
    btn.textContent = originalText;
    btn.disabled = false;
  });

  document.getElementById('syncFromFirestore').addEventListener('click', async () => {
    const btn = document.getElementById('syncFromFirestore');
    const originalText = btn.textContent;
    btn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
    btn.disabled = true;
    await loadFromFirestore();
    alert('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firestore');
    btn.textContent = originalText;
    btn.disabled = false;
  });

  document.getElementById('refresh').addEventListener('click', async () => {
    const btn = document.getElementById('refresh');
    const originalText = btn.textContent;
    btn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...';
    btn.disabled = true;
    if(currentDataSource === 'Realtime Database') {
      await loadFromRealtimeDatabase();
    } else {
      await loadFromFirestore();
    }
    btn.textContent = originalText;
    btn.disabled = false;
  });

  // ========== Export to CSV ==========
  document.getElementById('exportCsv').addEventListener('click', () => {
    if(!allTransactions.length) {
      alert('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
      return;
    }

    const rows = [['Ø§Ù„Ù†ÙˆØ¹', 'Ø§Ù„ÙØ¦Ø©/Ø§Ù„Ø§Ø³Ù…', 'Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨', 'Ø§Ù„Ù…Ø¨Ù„Øº', 'Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ù…Ù„Ø§Ø­Ø¸Ø©', 'ÙˆÙ‚Øª Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡', 'Ø§Ù„Ù…ØµØ¯Ø±']];
    
    allTransactions.forEach(op => {
      const dt = op.date.toLocaleDateString('ar-QA');
      const ct = op.createdAt.toLocaleString('ar-QA');
      
      rows.push([
        op.type === 'invoice' ? 'ÙØ§ØªÙˆØ±Ø©' : 'Ù…Ø¹Ø§Ø´',
        op.category || op.name || '',
        op.mandoub || '',
        op.amount.toFixed(2),
        dt,
        op.note || '',
        ct,
        op.source === 'realtime' ? 'Realtime Database' : 'Firestore'
      ]);
    });

    const csv = '\uFEFF' + rows.map(r => r.map(c => `"${String(c||'').replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); 
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); 
    a.href = url; 
    a.download = `transactions_${new Date().toISOString().slice(0,10)}.csv`; 
    a.click(); 
    URL.revokeObjectURL(url);

    alert('âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­!');

    if(analytics) {
      analytics.logEvent('export_csv', { record_count: allTransactions.length, source: currentDataSource });
    }
  });

</script>
</body>
</html>